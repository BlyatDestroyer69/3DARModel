<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bukit Kiara AR World</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.1/dist/mindar-image-aframe.prod.js"></script>

    <style>
        body {
            margin: 0;
            overflow: hidden; /* Important for AR scene to fill screen */
            font-family: 'Inter', sans-serif;
            background-color: #f0f0f0;
        }

        /* The A-Frame scene will fill the screen */
        a-scene {
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            display: block; /* Ensure it's rendered as a block element */
            opacity: 0; /* Initially hidden, will fade in after welcome screen */
            transition: opacity 1s ease-in-out; /* Smooth transition for scene visibility */
        }
        a-scene.visible {
            opacity: 1; /* Make scene visible */
        }

        /* Welcome Screen Styles */
        #welcome-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d); /* Ocean sunset gradient */
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            z-index: 100; /* Ensure it's on top */
            transition: opacity 1s ease-out; /* Smooth fade out */
        }
        #welcome-screen.hidden {
            opacity: 0;
            pointer-events: none; /* Disable interaction when hidden */
        }
        #welcome-screen h1 {
            font-size: 3em;
            margin-bottom: 20px;
        }
        #welcome-screen p {
            font-size: 1.2em;
            margin-bottom: 30px;
            max-width: 600px;
            line-height: 1.5;
        }
        #welcome-button {
            background-color: #4CAF50; /* Green */
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1.2em;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        #welcome-button:hover {
            background-color: #45a049;
        }

        /* Info Panel Styles */
        #info-panel {
            position: absolute;
            top: 10px;
            left: 10px;
            width: 300px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 20px;
            border-radius: 8px;
            z-index: 99; /* Below welcome screen, above AR scene */
            display: none; /* Initially hidden */
            flex-direction: column;
            box-sizing: border-box;
            max-height: calc(100vh - 20px);
            overflow-y: auto;
        }
        #info-panel h2 {
            margin-top: 0;
            font-size: 1.5em;
            margin-bottom: 10px;
            color: #ADD8E6; /* Light Blue */
        }
        #info-panel p {
            font-size: 0.9em;
            line-height: 1.4;
            margin-bottom: 15px;
        }
        #info-panel button {
            background-color: #3498db;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        #info-panel button:hover {
            background-color: #2980b9;
        }
        .close-button {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            color: white;
            font-size: 1.5em;
            cursor: pointer;
        }

        /* Style for the cursor */
        #cursor {
            pointer-events: none; /* Ensures cursor itself doesn't block clicks */
        }
        /* Mobile responsive adjustments for info panel */
        @media (max-width: 768px) {
            #info-panel {
                width: calc(100% - 20px); /* Full width minus padding */
                left: 10px;
                top: 50%; /* Position roughly in the middle vertically */
                transform: translateY(-50%);
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div id="welcome-screen">
        <h1>Welcome to Bukit Kiara AR World</h1>
        <p>Explore the natural beauty of Bukit Kiara like never before. Use Augmented Reality to discover hidden gems and learn about the environment.</p>
        <button id="welcome-button">Start Exploring</button>
    </div>

    <a-scene
        id="ar-scene"
        vr-mode-ui="enabled: false"
        renderer="logarithmicDepthBuffer: true;"
        mindar-image="imageTargetSrc: ./assets/targets.mind; filterMinCF:0.0001; filterBeta: 0.001; warmupTolerance: 0.1; missTolerance: 0.5;">
        <a-assets>
            <a-asset-item id="map-model-asset" src="./models/map_model.glb"></a-asset-item>
        </a-assets>

        <a-entity mindar-image-target="targetIndex: 0">
            <a-entity id="ar-map-gltf-container" scale="0 0 0" position="0 -1 0">
                </a-entity>
            </a-entity>

        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
    </a-scene>

    <div id="info-panel">
        <button class="close-button" id="close-info-panel">X</button>
        <h2 id="info-panel-title"></h2>
        <p id="info-panel-description"></p>
        <button id="go-to-checkpoint">Go to Checkpoint</button>
    </div>

    <script type="module">
        // Data for your checkpoints, adapted for A-Frame positioning
        // IMPORTANT: You will need to adjust these 'position' values (x, y, z)
        // based on the scale and origin of your 'map_model.glb' and where you want
        // the checkpoints to appear *relative to the loaded map*.
        // 'y' value typically represents height above the map.
        const CHECKPOINTS_DATA = [
            { id: 1, position: { x: 0.5, y: 0.1, z: 0 }, url: 'checkpoint_1.html?checkpointId=1', name: 'Checkpoint 1: The Mystical Flower', description: 'Discover the vibrant colors of this unique flora.' },
            { id: 2, position: { x: -0.3, y: 0.1, z: 0.2 }, url: 'checkpoint_1.html?checkpointId=2', name: 'Checkpoint 2: Woodpecker\'s Perch', description: 'Observe the elusive Hairy Woodpecker in its natural habitat.' },
            { id: 3, position: { x: 0, y: 0.1, z: -0.4 }, url: 'checkpoint_1.html?checkpointId=3', name: 'Checkpoint 3: Margarita Meadows', description: 'A beautiful expanse of Margarita Flower Bushes.' },
            { id: 4, position: { x: -0.6, y: 0.1, z: -0.1 }, url: 'checkpoint_1.html?checkpointId=4', name: 'Checkpoint 4: Serpent\'s Slumber', description: 'Learn about the fascinating reptiles inhabiting this area.' },
            { id: 5, position: { x: 0.2, y: 0.1, z: 0.4 }, url: 'checkpoint_1.html?checkpointId=5', name: 'Checkpoint 5: Crystal Tree Haven', description: 'Uncover the legends of the Japanese Tree Crystal.' }
        ];

        let currentCheckpointId = null; // Store the ID of the currently selected checkpoint

        // Get references to DOM elements
        const welcomeScreen = document.getElementById('welcome-screen');
        const welcomeButton = document.getElementById('welcome-button');
        const arScene = document.getElementById('ar-scene'); // The A-Frame scene
        const infoPanel = document.getElementById('info-panel');
        const closeInfoPanelButton = document.getElementById('close-info-panel');
        const infoPanelTitle = document.getElementById('info-panel-title');
        const infoPanelDescription = document.getElementById('info-panel-description');
        const goToCheckpointButton = document.getElementById('go-to-checkpoint');

        let arMapGltfContainer; // Reference to the A-Frame entity that will hold the GLTF model

        document.addEventListener('DOMContentLoaded', () => {
            arMapGltfContainer = document.getElementById('ar-map-gltf-container');

            // --- Welcome Screen Logic ---
            welcomeButton.addEventListener('click', () => {
                welcomeScreen.classList.add('hidden'); // Fade out welcome screen
                // After welcome screen hides, fade in the AR scene to activate camera
                setTimeout(() => {
                    arScene.classList.add('visible'); // Make AR scene visible
                    // MindAR automatically starts the camera when the a-scene is initialized and visible
                    console.log("Welcome screen hidden, AR scene fading in.");
                }, 1000); // Duration matches CSS transition for smoother fade
            });

            // --- MindAR Image Target Logic ---
            // Note: MindAR uses the 'found' and 'lost' events directly on the a-entity with mindar-image-target
            const mindarImageTargetEntity = document.querySelector('[mindar-image-target]');

            mindarImageTargetEntity.addEventListener('targetFound', () => {
                console.log("Image target found! Loading map model and checkpoints.");

                // Check if the map model is already loaded to prevent duplicates
                if (!arMapGltfContainer.querySelector('a-gltf-model')) {
                    const mapModel = document.createElement('a-gltf-model');
                    mapModel.setAttribute('src', '#map-model-asset');
                    // Adjust scale and rotation here to fit your marker and model's orientation.
                    // Common GLTF models are Y-up, so -90 on X-axis for rotation is common to align with marker.
                    mapModel.setAttribute('scale', '0.01 0.01 0.01'); // Start at a tiny scale before emerging
                    mapModel.setAttribute('rotation', '-90 0 0'); // Example rotation, adjust if your model's orientation is different

                    arMapGltfContainer.appendChild(mapModel);

                    // Add an animation for the map model to "emerge"
                    // Animates from a smaller scale (0.01) to its final scale (e.g., 0.5)
                    // and from below (-0.5 on y-axis) to its final position (0 on y-axis)
                    const emergeScaleAnimation = document.createElement('a-animation');
                    emergeScaleAnimation.setAttribute('attribute', 'scale');
                    emergeScaleAnimation.setAttribute('from', '0.01 0.01 0.01'); // Starting scale (very small)
                    emergeScaleAnimation.setAttribute('to', '0.5 0.5 0.5'); // Target scale of your map, adjust this!
                    emergeScaleAnimation.setAttribute('dur', '1800'); // Duration in milliseconds
                    emergeScaleAnimation.setAttribute('easing', 'ease-out-elastic'); // Smooth, bouncy emergence
                    arMapGltfContainer.appendChild(emergeScaleAnimation);

                    const emergePositionAnimation = document.createElement('a-animation');
                    emergePositionAnimation.setAttribute('attribute', 'position');
                    emergePositionAnimation.setAttribute('from', '0 -0.5 0'); // Start slightly below the marker
                    emergePositionAnimation.setAttribute('to', '0 0 0'); // End at the marker's surface
                    emergePositionAnimation.setAttribute('dur', '1800'); // Same duration as scale for sync
                    emergePositionAnimation.setAttribute('easing', 'ease-out-elastic');
                    arMapGltfContainer.appendChild(emergePositionAnimation);


                    // Add ambient light to the scene for better model visibility
                    const ambientLight = document.createElement('a-entity');
                    ambientLight.setAttribute('light', 'type: ambient; color: #BBB; intensity: 0.8');
                    mindarImageTargetEntity.appendChild(ambientLight);

                    // Add a directional light for shadows and definition
                    const directionalLight = document.createElement('a-entity');
                    directionalLight.setAttribute('light', 'type: directional; color: #FFF; intensity: 0.6; castShadow: true;');
                    directionalLight.setAttribute('position', '1 2 1'); // Position relative to marker
                    mindarImageTargetEntity.appendChild(directionalLight);

                    // After the map model is loaded, dynamically add checkpoint spheres
                    mapModel.addEventListener('model-loaded', () => {
                        CHECKPOINTS_DATA.forEach(cp => {
                            const checkpointSphere = document.createElement('a-sphere');
                            checkpointSphere.setAttribute('position', `${cp.position.x} ${cp.position.y} ${cp.position.z}`);
                            checkpointSphere.setAttribute('radius', '0.05'); // Adjust radius based on your map scale
                            checkpointSphere.setAttribute('color', '#FF0000'); // Red for visibility
                            checkpointSphere.setAttribute('opacity', '0.7');
                            checkpointSphere.setAttribute('id', `checkpoint-${cp.id}`); // Unique ID
                            checkpointSphere.setAttribute('data-checkpoint-id', cp.id); // Custom data attribute for easy lookup
                            checkpointSphere.setAttribute('class', 'checkpoint-sphere'); // Class for raycaster

                            arMapGltfContainer.appendChild(checkpointSphere);
                        });
                        console.log("Checkpoints added to AR map after model loaded.");
                    });
                }
            });

            mindarImageTargetEntity.addEventListener('targetLost', () => {
                console.log("Image target lost! Hiding info panel.");
                hideInfoPanel(); // Hide info panel if map disappears from view
            });

            // --- Checkpoint Interaction in AR Scene ---
            // A-Frame uses a unified click event on the scene, then delegates
            arScene.addEventListener('click', (evt) => {
                // Check if the clicked element has the 'checkpoint-sphere' class
                if (evt.target.classList.contains('checkpoint-sphere')) {
                    const checkpointId = evt.target.getAttribute('data-checkpoint-id');
                    const checkpoint = CHECKPOINTS_DATA.find(cp => cp.id == checkpointId);
                    if (checkpoint) {
                        displayInfoPanel(checkpoint);
                        console.log(`Checkpoint ${checkpoint.id} clicked!`);
                    }
                }
            });

            // --- Info Panel Logic ---
            closeInfoPanelButton.addEventListener('click', hideInfoPanel);

            goToCheckpointButton.addEventListener('click', () => {
                if (currentCheckpointId !== null) {
                    const checkpoint = CHECKPOINTS_DATA.find(cp => cp.id === currentCheckpointId);
                    if (checkpoint) {
                        window.location.href = checkpoint.url; // Navigate to checkpoint page
                    }
                }
            });

            function displayInfoPanel(checkpoint) {
                infoPanelTitle.textContent = checkpoint.name;
                infoPanelDescription.textContent = checkpoint.description;
                currentCheckpointId = checkpoint.id;
                infoPanel.style.display = 'flex'; // Show the info panel
            }

            function hideInfoPanel() {
                infoPanel.style.display = 'none'; // Hide the info panel
                currentCheckpointId = null;
            }
        });
    </script>
</body>
</html>
