<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bukit Kiara AR World</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Inter', sans-serif;
            background-color: #f0f0f0;
        }

        canvas {
            display: block;
            width: 100vw;
            height: 100vh;
        }

        /* Welcome Screen Styles */
        #welcome-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d); /* Ocean sunset gradient */
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            z-index: 100; /* Ensure it's on top of everything */
            opacity: 1;
            transition: opacity 1s ease-out;
        }

        #welcome-screen.hidden {
            opacity: 0;
            pointer-events: none; /* Make it unclickable after fading */
        }

        #welcome-screen h1 {
            font-size: 4em;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.4);
            letter-spacing: 2px;
        }

        #welcome-screen p {
            font-size: 1.5em;
            margin-bottom: 40px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }

        #welcome-button {
            background-color: #f1c40f; /* Yellow */
            color: #2c3e50; /* Dark blue-grey */
            padding: 15px 40px;
            border: none;
            border-radius: 30px;
            font-size: 1.8em;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            text-transform: uppercase;
        }

        #welcome-button:hover {
            background-color: #f39c12; /* Darker yellow/orange */
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
        }

        /* Info Panel Styles (existing) */
        #info-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(45, 45, 45, 0.9);
            color: white;
            padding: 15px;
            border-radius: 12px;
            display: none; /* Initially hidden */
            z-index: 10;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            max-width: 320px;
            transition: opacity 0.3s ease-in-out;
            opacity: 0;
            pointer-events: none;
            transform: translate(-50%, -100%);
        }

        #info-panel.visible {
            opacity: 1;
            display: block;
        }

        #info-panel h3 {
            margin-top: 0;
            margin-bottom: 8px;
            font-size: 1.2em;
            color: #ADD8E6;
        }

        #info-panel p {
            margin-bottom: 0;
            font-size: 0.95em;
            line-height: 1.4;
        }

        #info-panel a {
            color: #87CEEB;
            text-decoration: none;
            font-weight: bold;
            display: block;
            margin-top: 8px;
        }

        #info-panel a:hover {
            color: #C1E8FF;
            text-decoration: underline;
        }
    </style>

    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.165.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.165.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>
    <!-- Welcome Screen -->
    <div id="welcome-screen">
        <h1>Welcome to Bukit Kiara AR World</h1>
        <p>Embark on an interactive journey to discover amazing wildlife!</p>
        <button id="welcome-button">Enter Experience</button>
    </div>

    <!-- Info Panel (remains the same) -->
    <div id="info-panel">
        <h3 id="checkpoint-name"></h3>
        <p id="animal-description"></p>
        <p><a id="checkpoint-link" href="#" target="_blank">View Details</a></p>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { FBXLoader } from 'three/addons/loaders/FBXLoader.js';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // Set up the scene, camera, and renderer
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0xbfd1e5); // Light blue background

        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.01, 1000);
        camera.position.set(0, 50, 250); // Initial camera position (adjusted for further and higher view)

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // Add OrbitControls for camera interaction
        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true; // Smooth camera movement
        controls.dampingFactor = 0.1;
        controls.minDistance = 5;
        controls.maxDistance = 1000; // Maximum zoom distance (increased significantly)
        controls.enabled = false; // Initially disable controls

        // Add ambient light to illuminate all objects equally
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
        scene.add(ambientLight);

        // Add a directional light for shadows and more realistic lighting
        const dirLight = new THREE.DirectionalLight(0xffffff, 0.5);
        dirLight.position.set(10, 20, 10); // Position of the light source
        scene.add(dirLight);

        // Initialize FBXLoader
        const loader = new FBXLoader();
        let loadedModel = null; // Store the loaded FBX model

        // --- Checkpoint Data ---
        const checkpointData = {
            'CheckpointFlag1_Clickable': {
                displayName: 'Checkpoint 1',
                animals: 'Prepared for your ultimate discovery of our wildlife animal, **Hammerhead sharks** and the majestic **Great White Sharks**.',
                url: 'checkpoint_1.html'
            },
            'CheckpointFlag2_Clickable': {
                displayName: 'Checkpoint 2',
                animals: 'Witness the playful antics of **Dolphins** and the graceful movements of **Sea Turtles**.',
                url: 'checkpoint_2.html'
            },
            'CheckpointFlag3_Clickable': {
                displayName: 'Checkpoint 3',
                animals: 'Explore the vibrant coral reefs and encounter the colorful **Clownfish** and elegant **Manta Rays**.',
                url: 'checkpoint_3.html'
            },
            'CheckpointFlag4_Clickable': {
                displayName: 'Checkpoint 4',
                animals: 'Discover the resilience of **Coral Polyps** and the darting **Reef Sharks**.',
                url: 'checkpoint_4.html'
            },
            'CheckpointFlag5_Clickable': {
                displayName: 'Checkpoint 5',
                animals: 'Encounter the fascinating **Jellyfish** and various **Anemonefish** species.',
                url: 'checkpoint_5.html'
            },
            'CheckpointFlag6_Clickable': {
                displayName: 'Checkpoint 6',
                animals: 'Observe the majestic **Whales** on their migration path and graceful **Squid**.',
                url: 'checkpoint_6.html'
            },
            'CheckpointFlag7_Clickable': {
                displayName: 'Checkpoint 7',
                animals: 'Learn about the unique **Seahorses** and the camouflaged **Octopus**.',
                url: 'checkpoint_7.html'
            },
            'CheckpointFlag8_Clickable': {
                displayName: 'Checkpoint 8',
                animals: 'Explore the deep sea trenches, home to **Anglerfish** and giant **Tube Worms**.',
                url: 'checkpoint_8.html'
            },
            'CheckpointFlag9_Clickable': {
                displayName: 'Checkpoint 9',
                animals: 'Witness the beauty of **Starfish** and the intriguing **Moray Eels**.',
                url: 'checkpoint_9.html'
            }
        };

        // Load the FBX model
        loader.load('BukitKiaraMap.fbx', fbx => {
            loadedModel = fbx; // Assign the loaded model
            fbx.scale.set(0.01, 0.01, 0.01); // Scale the model down

            // IMPORTANT: This rotation line has been removed/commented out
            // because you confirmed your FBX model is already Y-up from your 3D software.
            // fbx.rotation.x = -Math.PI / 2; // (Previously here, now removed)

            // Center the model in the scene
            const box = new THREE.Box3().setFromObject(fbx);
            const center = box.getCenter(new THREE.Vector3());
            fbx.position.sub(center);

            scene.add(fbx); // Add the model to the scene
        }, xhr => {
            // Progress callback
            console.log(`Loading: ${Math.round((xhr.loaded / xhr.total) * 100)}%`);
        }, err => {
            console.error('Error loading FBX:', err);
        });

        // Raycaster for detecting interactions with 3D objects
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();
        let currentIntersected = null; // To keep track of the currently hovered object

        // Get references to the info panel elements
        const infoPanel = document.getElementById('info-panel');
        const checkpointName = document.getElementById('checkpoint-name');
        const animalDescription = document.getElementById('animal-description');
        const checkpointLink = document.getElementById('checkpoint-link');

        // Function to update and show the info panel
        function showInfoPanel(name, description, linkUrl, clientX, clientY) {
            checkpointName.textContent = name;
            animalDescription.innerHTML = description;
            checkpointLink.href = linkUrl;
            checkpointLink.textContent = `View Details for ${name}`;

            infoPanel.style.left = `${clientX}px`;
            infoPanel.style.top = `${clientY}px`;
            infoPanel.classList.add('visible');
        }

        // Function to hide the info panel
        function hideInfoPanel() {
            infoPanel.classList.remove('visible');
        }

        // Event listener for mouse movement (HOVER)
        window.addEventListener('mousemove', event => {
            if (!controls.enabled) return; // Only process hover if controls are enabled

            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

            raycaster.setFromCamera(mouse, camera);

            const clickable = [];
            if (loadedModel) {
                loadedModel.traverse(obj => {
                    if (obj.isMesh && checkpointData[obj.name]) {
                        clickable.push(obj);
                    }
                });
            }

            const intersects = raycaster.intersectObjects(clickable, true);

            if (intersects.length > 0) {
                const mesh = intersects[0].object;
                if (currentIntersected !== mesh) {
                    currentIntersected = mesh;
                    const data = checkpointData[mesh.name];
                    if (data) {
                        showInfoPanel(data.displayName, data.animals, data.url, event.clientX, event.clientY);
                    }
                }
            } else {
                if (currentIntersected) {
                    hideInfoPanel();
                    currentIntersected = null;
                }
            }
        });

        // Event listener for mouse click (to allow navigating to the URL)
        window.addEventListener('click', event => {
            if (!controls.enabled) return; // Only process click if controls are enabled

            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);

            const clickable = [];
            if (loadedModel) {
                loadedModel.traverse(obj => {
                    if (obj.isMesh && checkpointData[obj.name]) {
                        clickable.push(obj);
                    }
                });
            }

            const intersects = raycaster.intersectObjects(clickable, true);
            if (intersects.length > 0) {
                const mesh = intersects[0].object;
                const data = checkpointData[mesh.name];
                if (data && data.url) {
                    window.open(data.url, '_blank'); // Open the URL in a new tab
                }
            }
        });

        // Animation loop - now called only after welcome screen disappears
        function animate() {
            requestAnimationFrame(animate);
            controls.update(); // Update OrbitControls
            renderer.render(scene, camera);
        }

        // Welcome screen logic
        const welcomeScreen = document.getElementById('welcome-screen');
        const welcomeButton = document.getElementById('welcome-button');

        welcomeButton.addEventListener('click', () => {
            // Start the animation and enable controls when the button is clicked
            animate();
            controls.enabled = true;
            welcomeScreen.classList.add('hidden'); // Fade out the welcome screen
        });

        // Initial setup on window load: Hide canvas until welcome button clicked
        window.onload = function () {
            // Renderer's canvas is already added to body.
            // By default, controls are disabled, and animation loop not yet started.
            // The welcome screen overlay covers everything initially.
        }

        // Handle window resizing
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
